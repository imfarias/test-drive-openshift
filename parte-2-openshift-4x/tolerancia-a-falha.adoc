[[tolerância-a-falhas]]
= Tolerância a falhas
:imagesdir: images

O Openshift garante que a quantidade de instâncias (PODs) definidas para uma aplicação seja respeitada. O responsável por fazer este controle é o Replication Controller.

Neste laboratório vamos testar esse recurso.

[[scale-up]]
== Scale up

`ATENÇÃO!`

Não escale para muitos pods pois isso pode causar a queda do ambiente, já o OpenShift está rodando em ambiente compartilhado.

Selecione a seta para cima na lateral do pod, escalando para 2 pods no total.

image:https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/scale-out.gif[image]

Enquanto o círculo estiver cinza, significa que o pod está sendo provisionado.

Quando o círculo estiver azul significa que o novo pod foi corretamente provisionado e já está pronto para receber novas requisições.

_________________________________________________________________________________________
Estes novos PODs são imediatamente incluídos no balanceamento de carga. Se estiver +
usando o browser para testar o balanceamento certifique-se de apagar o cookie pois este +
é utilizado para afinidade de sessão (sticky session).
_________________________________________________________________________________________

[[garantia-do-número-de-réplicas]]
== Garantia do número de réplicas

Para testar o comportamento vamos deletar um POD em execução, o intuito é simular uma falha.

image:https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/delete-pod.gif.gif[image]

1.  Selecione um dos pods, no menu superior direito selecione a opção _Actions_ > _Delete_ e confirme a operação.
2.  Selecione a opção _Overview_ no menu lateral esquerdo e veja que um novo pod será recriado.

_______________________________________________________________________________________________________________________________________
Este comportamento evita aquele caso clássico de precisar ligar para alguém de operações para reiniciar a aplicação em um caso de falha
_______________________________________________________________________________________________________________________________________

Quando o POD é deletado, o Openshift o recupera automaticamente como pode ser visto no video abaixo. Nesse exemplo, um POD novo é criado (cor azul claro) e outro está sendo finalizado (cor azul escuro) mas sempre mantendo a quantidade de 2 instâncias rodando.

image:https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/deleting.gif[image]

Também podemos deletar um POD usando a linha de comando:

[source,text]
----
oc delete po <nome do pod>
----

image:https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/delete-pod.gif[image]

Na tela de monitoramento, também é refletido que um container foi eliminado e outro foi criado para substituir o antigo. Veja:

image:https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/selection_235.png[image]

Repare que o ID do container mudou pois foi realizada uma nova criação de POD.

[[limpeza-do-ambiente]]
== Limpeza do ambiente

Agora podemos apagar essa aplicação já que não a utilizaremos mais. O comando abaixo executa essa limpeza:

[source,text]
----
oc delete all -l app=workshop-openshift
----

Para saber o nome do seu projeto no Openshift, basta executar:

[source,text]
----
oc get projects
----

image:https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/delete-all.gif[image]

Ao fim desse lab, sua tela do Openshift deve estar conforme imagem abaixo:

image:https://raw.githubusercontent.com/guaxinim/test-drive-openshift/master/gitbook/assets/after-delete-all.gif[image]

[[mais-informações]]
=== Mais informações:

* https://docs.openshift.com/container-platform/3.11/architecture/core_concepts/deployments.html#replication-controllers
